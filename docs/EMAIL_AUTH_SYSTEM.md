# Email-Based Authentication System

## Overview

The WDIR app uses an email-based verification system instead of traditional license keys. This provides better UX and security.

## User Flow

### iOS App Activation

1. **User enters email** in the app
2. **App calls** `POST /api/auth/request-code` with email
3. **User receives** 6-digit code via email
4. **User enters code** in the app
5. **App calls** `POST /api/auth/verify-code` with email + code + device_info
6. **Backend returns** license details and device list
7. **App stores** license locally and is ready to use

### Web Portal Access (Future)

1. User enters email on website
2. Receives verification code
3. Enters code to access their settings
4. Can update company/inspector details
5. Changes sync to iOS on next login

## API Endpoints

### 1. Request Verification Code

**POST `/api/auth/request-code`**

Sends a 6-digit verification code to the user's email.

**Request:**
```json
{
  "email": "inspector@example.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Verification code sent to your email"
}
```

**Error Responses:**
- `404`: No license found for email
- `403`: License is deactivated
- `429`: Too many requests (max 5 per hour)

**Features:**
- Code expires in 10 minutes
- Rate limited to 5 attempts per hour
- Case-insensitive email matching

### 2. Verify Code & Activate

**POST `/api/auth/verify-code`**

Verifies the code and returns license details. Optionally registers a device.

**Request:**
```json
{
  "email": "inspector@example.com",
  "code": "123456",
  "device_info": {
    "device_id": "ABC-123-XYZ",
    "device_model": "iPhone 15 Pro",
    "os_version": "18.0"
  }
}
```

**Response:**
```json
{
  "success": true,
  "license": {
    "id": "uuid",
    "email": "inspector@example.com",
    "company_name": "Texas Termite Control",
    "company_phone": "(555) 123-4567",
    "company_license_number": "SPC-TX-12345",
    "inspector_name": "John Doe",
    "inspector_license": "LIC-12345",
    "is_active": true,
    "device_count": 2,
    "flagged_multi_device": false,
    ...
  },
  "devices": [
    {
      "id": "uuid",
      "device_id": "ABC-123-XYZ",
      "device_model": "iPhone 15 Pro",
      "first_activated_at": "2025-11-26T12:00:00Z",
      "last_used_at": "2025-11-26T12:00:00Z"
    }
  ]
}
```

**Error Responses:**
- `401`: Invalid or expired code
- `401`: Too many failed attempts (max 3)
- `403`: License is not active

**Features:**
- Device tracking (first activation + last used)
- Multi-device detection (3+ devices in 12 months)
- Admin email alert when multi-device threshold reached
- Auto-updates device info on subsequent logins

### 3. Report Usage Statistics

**POST `/api/usage/report`**

iOS app reports monthly usage statistics (report count only, no sensitive data).

**Request:**
```json
{
  "email": "inspector@example.com",
  "period": "2025-11",
  "report_count": 42
}
```

**Response:**
```json
{
  "success": true,
  "message": "Usage statistics recorded successfully"
}
```

**Features:**
- Called automatically by iOS app every 30 days
- Upserts (creates or updates) monthly stats
- Anonymous - only stores report count
- Used for engagement metrics in admin dashboard

## Device Tracking

### Purpose

- Detect license sharing/abuse
- Provide usage insights to admin
- Allow users to see their devices (future)

### How It Works

1. **First Activation:**
   - Device registered with ID, model, OS version
   - `first_activated_at` timestamp recorded

2. **Subsequent Logins:**
   - `last_used_at` updated
   - Device info refreshed

3. **Multi-Device Detection:**
   - Count distinct devices used in last 12 months
   - If ≥3 devices → Flag license
   - Send email alert to admin

4. **Admin Review:**
   - Admin reviews flagged licenses
   - Can add notes or deactivate if abusive
   - Most cases are legitimate (phone upgrade, tablet, test device)

### Device ID

Generated by iOS app using:
```swift
UIDevice.current.identifierForVendor?.uuidString
```

Persists across app reinstalls (unless all apps from vendor are deleted).

## Multi-Device Alerts

When a license is first flagged for 3+ devices:

**Admin receives email with:**
- License details (key, email, company)
- Device count
- List of recent devices (model, last used date)
- Link to admin dashboard

**Admin can:**
- Review usage patterns
- Add notes to license
- Contact customer if needed
- Deactivate license if abusive

## Database Schema

### `verification_codes`

```sql
CREATE TABLE verification_codes (
    id UUID PRIMARY KEY,
    email TEXT NOT NULL,
    code TEXT NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    attempts INT DEFAULT 0,
    verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Cleanup:** Old codes (>1 hour) periodically deleted.

### `devices`

```sql
CREATE TABLE devices (
    id UUID PRIMARY KEY,
    license_id UUID REFERENCES licenses(id),
    device_id TEXT NOT NULL,
    device_model TEXT,
    os_version TEXT,
    first_activated_at TIMESTAMPTZ,
    last_used_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE(license_id, device_id)
);
```

**Triggers:** Auto-updates `licenses.device_count` and `flagged_multi_device`.

### `usage_stats`

```sql
CREATE TABLE usage_stats (
    id UUID PRIMARY KEY,
    license_id UUID REFERENCES licenses(id),
    period TEXT NOT NULL, -- Format: YYYY-MM
    report_count INT,
    last_reported_at TIMESTAMPTZ,
    UNIQUE(license_id, period)
);
```

### Updated `licenses` table

**New fields:**
- `device_count INT` - Number of active devices (last 12 months)
- `flagged_multi_device BOOLEAN` - Flagged for 3+ devices
- `admin_notes TEXT` - Admin can add notes

## Email Templates

### Verification Code Email

- **Subject:** Your WDIR Verification Code
- **Content:** 6-digit code in large font
- **Expiration:** "This code will expire in 10 minutes"

### Welcome Email (License Created)

- **Subject:** Welcome to WDIR - Your License is Ready
- **Content:**
  - Greeting with inspector name
  - Company name
  - Getting started instructions:
    1. Download app
    2. Enter email
    3. Verify with code
    4. Start creating reports
  - Support contact

### Multi-Device Alert (To Admin)

- **Subject:** ⚠️ Multi-Device Alert: [Company Name]
- **Content:**
  - License details
  - Device count
  - List of devices
  - Link to admin dashboard

## Security Features

### Rate Limiting

- **Verification requests:** Max 5 per hour per email
- **Code attempts:** Max 3 per code
- **Code expiration:** 10 minutes

### Email Validation

- Case-insensitive matching
- Trimmed whitespace
- Normalized before lookup

### Device Security

- Device ID is vendor-specific (can't be spoofed across vendors)
- Device info stored for forensics
- Admin can review and take action

## iOS Implementation

### On App Launch

```swift
func checkLicenseStatus() {
    // Check if license cached locally
    if let cachedLicense = loadLicenseFromKeychain() {
        // Check if expired
        if !cachedLicense.isExpired {
            // Ready to use
            return
        }
    }

    // Show login screen
    showLoginScreen()
}
```

### Login Flow

```swift
// Step 1: Request code
func requestVerificationCode(email: String) async {
    let response = await api.post("/api/auth/request-code", body: ["email": email])
    // Show "Code sent! Check your email"
}

// Step 2: Verify code
func verifyCode(email: String, code: String) async {
    let deviceInfo = [
        "device_id": UIDevice.current.identifierForVendor?.uuidString,
        "device_model": UIDevice.current.model,
        "os_version": UIDevice.current.systemVersion
    ]

    let response = await api.post("/api/auth/verify-code", body: [
        "email": email,
        "code": code,
        "device_info": deviceInfo
    ])

    if response.success {
        // Save license to keychain
        saveLicenseToKeychain(response.license)

        // Navigate to main app
        showMainScreen()
    }
}
```

### Usage Reporting (30-Day Check-in)

```swift
func reportUsageIfNeeded() async {
    let lastReport = UserDefaults.standard.object(forKey: "lastUsageReport") as? Date
    let thirtyDaysAgo = Calendar.current.date(byAdding: .day, value: -30, to: Date())

    if lastReport == nil || lastReport! < thirtyDaysAgo! {
        let period = getCurrentPeriod() // e.g., "2025-11"
        let reportCount = getReportCount(for: period)

        await api.post("/api/usage/report", body: [
            "email": license.email,
            "period": period,
            "report_count": reportCount
        ])

        UserDefaults.standard.set(Date(), forKey: "lastUsageReport")
    }
}
```

## Testing

### Test Flow

1. **Run database migration:**
   ```sql
   -- In Supabase SQL Editor
   -- Copy/paste contents of supabase-migration-email-auth.sql
   ```

2. **Set up Resend (free account):**
   - Sign up at https://resend.com
   - Get API key
   - Add to `.env.local`:
     ```
     RESEND_API_KEY=re_xxx
     FROM_EMAIL=noreply@yourdomain.com
     ADMIN_EMAIL=admin@yourdomain.com
     ```

3. **Create test license:**
   - Use admin dashboard at `/admin`
   - Enter your real email
   - Company and inspector details

4. **Test verification flow:**
   ```bash
   # Request code
   curl -X POST http://localhost:3001/api/auth/request-code \
     -H "Content-Type: application/json" \
     -d '{"email":"your@email.com"}'

   # Check your email for code

   # Verify code
   curl -X POST http://localhost:3001/api/auth/verify-code \
     -H "Content-Type: application/json" \
     -d '{
       "email":"your@email.com",
       "code":"123456",
       "device_info":{
         "device_id":"test-device-1",
         "device_model":"iPhone 15 Pro",
         "os_version":"18.0"
       }
     }'
   ```

5. **Test multi-device detection:**
   - Verify with 3+ different `device_id` values
   - Check admin email for alert

## Future Enhancements

### User Self-Service Portal

- Users can login with email verification
- View all activated devices
- Deactivate old devices
- Update company/inspector details
- View usage statistics

### Enhanced Admin Dashboard

- Device list per license
- Usage graphs over time
- Multi-device flags with drill-down
- Bulk license operations
- Export to CSV

### Mobile Device Management

- Push notifications for license status
- Remote device deactivation
- License expiration warnings

## Migration from License Keys

The old license key system still works (backward compatibility):

- Old endpoint: `POST /api/license/activate` (with license_key)
- New endpoint: `POST /api/auth/verify-code` (with email + code)

Both routes coexist. iOS app will use new email-based flow.
